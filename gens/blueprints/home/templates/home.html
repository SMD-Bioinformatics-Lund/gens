{% extends "layout.html" %}
{% from "navbar.html" import navbar %}

{% block title %}GENS - version {{version}}{% endblock title %}

{% block css_style %}
  {{ super() }}
  <link rel='stylesheet' href='{{ url_for('home.static', filename='home.min.css') }}' type='text/css'>
{% endblock css_style %}

{% block scripts %}
  {{ super() }}
  <script
    type="module"
    src="{{ url_for('gens.static', filename='gens.min.js') }}"
  ></script>
{% endblock scripts %}

{% block body %}
  {{ navbar('home', version, current_user) }}
  {{ super() }}
{% endblock %}

{% block content %}
<gens-home></gens-home>
<div class="content">
  <h1>Samples</h1>
  <p>There are {{ total_samples }} samples loaded into Gens. Click on a <em>sample_id</em> to open it</p>
  <div>
    {{ samples_table(samples, pagination) }}
  </div>
</div>
{% endblock content %}

{% macro samples_table(samples_obj, pagination)%}
  {% set per_page = samples_obj | length %}
  <p class="display-info">Displaying <em>{{ pagination["from"] }}</em> to <em>{{ pagination["to"] }}</em> of <em>{{ per_page * pagination.last_page }}</em> samples</p>
  <table>
    <thead>
      <tr>
        <td>Case id</td>
        <td>Sample id(s)</td>
        <td>Genome build</td>
        <td>Overview file(s)</td>
        <td>BAM/BAF(s) found</td>
        <td>Import date</td>
      </tr>
    </thead>
    <tbody>
      {% for sample in samples_obj %}
        {% set genome_build=sample["genome_build"]%}
        {% set case_id=sample["case_id"]%}
        {% set sample_ids=sample["sample_ids"]%}
        <tr>
          <td id="case-cell">
            {% if case_id %}
              {% set sample_id_list = sample_ids | join(',') %}
              <a href="{{ url_for('gens.display_samples', case_id=case_id, sample_ids=sample_id_list, genome_build=genome_build) }}">{{ case_id }}</a>
              (<a href="{{ scout_base_url + "/case/case_id/" + case_id }}" target="_blank">Scout</a>)
            {% endif %}
          </td>
          <td>
            {% for sample_id in sample_ids %}            
              <a href="{{ url_for('gens.display_samples', case_id=case_id, sample_ids=sample_id, genome_build=genome_build) }}" target="_blank">{{ sample_id }}</a>
            {% endfor %}
          </td>
          <td id="build-cell" class="align-right">{{ genome_build }}</td>
          <td id="overview-cell"  class="align-right">
            {% if sample["has_overview_file"] %}
              <span class="icon icon-check"></span>
            {% else %}
              <span class="icon icon-x icon-color-red"></span>
            {% endif %}
          </td>
          <td id="has-files-cell" class="align-right">
            {% if sample["files_present"] %}
              <span class="icon icon-check"></span>
            {% else %}
              <span class="icon icon-x icon-color-red"></span>
            {% endif %}
          </td>
          <td id="date-cell">{{sample["created_at"]}}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {{ pagination_bar(pagination) }}
{% endmacro %}

{% macro pagination_bar(pagination)%}
  <div class="pagination">
    <ul>
      {% set start = 1 if pagination["current_page"] == 1 else pagination["current_page"] - 1 %}
      <!-- next -->
      <li class="page-item {{ 'disabled' if pagination["current_page"] == 1 else '' }}">
        <a href="{{url_for('home.home', page=pagination["current_page"] - 1) }}">Previous</a>
      </li>
      <!-- create numbers -->
      {% for num in range(start, start + 3) %}
        <li class="page-item {{ 'disabled' if pagination["last_page"] < num else '' }} {{ 'selected' if pagination["current_page"] == num else '' }}">
          <a href="{{url_for('home.home', page=num) }}">{{ num }}</a>
        </li>
      {% endfor %}
      <!-- previous -->
      <li class="page-item {{ 'disabled' if pagination["current_page"] == pagination["last_page"] else '' }}">
        <a href="{{url_for('home.home', page=pagination["current_page"] + 1) }}">Next</a>
      </li>
    </ul>
  </div>
{% endmacro %}
